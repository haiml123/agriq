generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//
enum role_type {
  SUPER_ADMIN
  ORG_ADMIN
  OPERATOR
}

enum alert_severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum alert_status {
  OPEN
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

enum metric_type {
  TEMPERATURE
  HUMIDITY
  EMC
}

enum trigger_scope {
  ORGANIZATION
  ALL
}

enum notification_channel {
  EMAIL
  SMS
  PUSH
  WEBHOOK
}

enum notification_status {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

enum invite_status {
  PENDING
  ACCEPTED
  EXPIRED
  REVOKED
}

// NEW: Entity status enum for Organization and User
enum entity_status {
  ACTIVE
  PENDING
  BLOCKED
  DELETED
}

// NEW: users.user_role enum
enum user_role {
  SUPER_ADMIN
  ADMIN
  OPERATOR
}

//
// ORGANIZATION & ACCESS CONTROL
//

model Organization {
  id     String        @id @default(cuid())
  name   String
  status entity_status @default(ACTIVE)

  // Relations
  users         User[]
  sites         Site[]
  eventTriggers EventTrigger[]
  invites       Invite[]
  commodities   Commodity[]
  alerts        Alert[]
  gateways      Gateway[]

  // Audit
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("organization")
}

model User {
  id       String        @id @default(cuid())
  email    String        @unique
  password String?
  phone    String?
  name     String
  status   entity_status @default(ACTIVE)

  // NEW: user-level role enum
  userRole user_role @default(OPERATOR) @map("user_role")

  languagePreference String? @map("language_preference")

  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // site_users: many-to-many User <-> Site
  siteUsers SiteUser[]

  // Auth - Refresh tokens
  refreshTokens RefreshToken[]

  // Invites created by this user
  createdInvites Invite[] @relation("invite_creator")
  acceptedInvite Invite?  @relation("invite_acceptor")

  // Triggers (creator/updater relations)
  createdTriggers EventTrigger[] @relation("trigger_creator")
  updatedTriggers EventTrigger[] @relation("trigger_updater")

  // Alerts
  resolvedAlerts Alert[] @relation("alert_resolver")
  alerts         Alert[] @relation("alert_user")

  // Notifications received
  notifications AlertNotification[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([status])
  @@map("user")
}

// Refresh token model for JWT auth
model RefreshToken {
  id    String @id @default(cuid())
  token String @unique

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([expiresAt])
  @@map("refresh_token")
}

// Invite model for user invitations
model Invite {
  id    String @id @default(cuid())
  token String @unique
  email String

  // Organization the user is invited to
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Optional: Site-level access
  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id])

  // Invite status
  status    invite_status @default(PENDING)
  expiresAt DateTime      @map("expires_at")

  // Who created the invite
  createdById String @map("created_by_id")
  createdBy   User   @relation("invite_creator", fields: [createdById], references: [id])

  // Who accepted (links to the created user)
  acceptedById String?   @unique @map("accepted_by_id")
  acceptedBy   User?     @relation("invite_acceptor", fields: [acceptedById], references: [id])
  acceptedAt   DateTime? @map("accepted_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@index([status])
  @@index([organizationId])
  @@map("invite")
}

//
// STRUCTURE: SITE → COMPOUND → CELL
//

model Site {
  id   String @id @default(cuid())
  name String

  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id])

  // Location
  address   String?
  latitude  Float?
  longitude Float?

  // Relations
  compounds Compound[]
  alerts    Alert[]
  trades    Trade[]
  triggers  EventTrigger[]
  invites   Invite[]
  gateways  Gateway[]

  // site_users: many-to-many Site <-> User
  siteUsers SiteUser[]

  // Audit
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("site")
}

// site_users join table
model SiteUser {
  userId   String    @map("user_id")
  siteId   String    @map("site_id")
  siteRole user_role @default(OPERATOR) @map("site_role")

  user User @relation(fields: [userId], references: [id])
  site Site @relation(fields: [siteId], references: [id])

  @@id([userId, siteId])
  @@map("site_user")
}

model Compound {
  id     String        @id @default(cuid())
  name   String
  status entity_status

  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id])

  // Relations
  cells    Cell[]
  alerts   Alert[]
  trades   Trade[]
  triggers EventTrigger[]

  // Audit
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("compound")
}

model Cell {
  id       String        @id @default(cuid())
  name     String
  status   entity_status
  capacity Float

  compoundId String   @map("compound_id")
  compound   Compound @relation(fields: [compoundId], references: [id])

  // Relations
  gateways        Gateway[]
  alerts          Alert[]
  readings        SensorReading[]
  gatewayReadings GatewayReading[]
  trades          Trade[]
  eventTriggers   EventTrigger[]

  // Audit
  createdBy String?  @map("created_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("cell")
}

//
// SENSORS & READINGS
//

model Sensor {
  id         String        @id @default(cuid())
  externalId String        @unique @map("external_id")
  name       String?
  status     entity_status

  gatewayId String  @map("gateway_id")
  gateway   Gateway @relation(fields: [gatewayId], references: [id])

  readings SensorReading[]
  alerts   Alert[]

  createdBy    String?        @map("created_by")
  createdAt    DateTime       @default(now()) @map("created_at")
  updatedAt    DateTime       @updatedAt @map("updated_at")
  EventTrigger EventTrigger[]

  @@map("sensor")
}

model Gateway {
  id         String        @id @default(cuid())
  externalId String        @unique @map("external_id")
  name       String?
  status     entity_status

  cellId String? @unique @map("cell_id")
  cell   Cell?   @relation(fields: [cellId], references: [id])

  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id])

  sensors        Sensor[]
  sensorReadings SensorReading[]
  readings       GatewayReading[]

  createdBy     String?         @map("created_by")
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  @@map("gateway")
}

model GatewayReading {
  id String @id @default(cuid())

  gatewayId String  @map("gateway_id")
  gateway   Gateway @relation(fields: [gatewayId], references: [id])

  cellId String @map("cell_id")
  cell   Cell   @relation(fields: [cellId], references: [id])

  temperature    Float
  humidity       Float
  batteryPercent Float    @map("battery_percent")
  recordedAt     DateTime @map("recorded_at")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([gatewayId, recordedAt])
  @@index([cellId, recordedAt])
  @@map("gateway_reading")
}

model SensorReading {
  id String @id @default(cuid())

  sensorId String @map("sensor_id")
  sensor   Sensor @relation(fields: [sensorId], references: [id])

  gatewayId String  @map("gateway_id")
  gateway   Gateway @relation(fields: [gatewayId], references: [id])

  cellId String @map("cell_id")
  cell   Cell   @relation(fields: [cellId], references: [id])

  temperature    Float
  humidity       Float
  batteryPercent Float    @map("battery_percent")
  recordedAt     DateTime @map("recorded_at")
  createdAt      DateTime @default(now()) @map("created_at")

  @@index([sensorId, recordedAt])
  @@index([gatewayId, recordedAt])
  @@index([cellId, recordedAt])
  @@map("sensor_reading")
}

//
// EVENT TRIGGERS
//

model EventTrigger {
  id          String  @id @default(cuid())
  name        String
  description String?

  scopeType trigger_scope @default(ALL) @map("scope_type")

  commodityTypeId String?        @map("commodity_type_id")
  commodityType   CommodityType? @relation(fields: [commodityTypeId], references: [id])

  // link trigger directly to a commodity (triggers.commodity_id > commodities.id)
  commodityId String?    @map("commodity_id")
  commodity   Commodity? @relation(fields: [commodityId], references: [id])

  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  siteId String? @map("site_id")
  site   Site?   @relation(fields: [siteId], references: [id])

  compoundId String?   @map("compound_id")
  compound   Compound? @relation(fields: [compoundId], references: [id])

  // link trigger to specific sensor and cell (triggers.sensor_id > sensors.id, triggers.cell_id > cells.id)
  sensorId String? @map("sensor_id")
  sensor   Sensor? @relation(fields: [sensorId], references: [id])

  cellId String? @map("cell_id")
  cell   Cell?   @relation(fields: [cellId], references: [id])

  conditionLogic String @default("AND")
  conditions     Json
  actions        Json

  severity alert_severity @default(MEDIUM)
  isActive Boolean        @default(true) @map("is_active")
  status   entity_status  @default(ACTIVE)

  alerts Alert[]

  createdBy     String @map("created_by")
  createdByUser User   @relation("trigger_creator", fields: [createdBy], references: [id])

  updatedBy     String? @map("updated_by")
  updatedByUser User?   @relation("trigger_updater", fields: [updatedBy], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([isActive, scopeType])
  @@index([siteId])
  @@index([organizationId])
  @@map("event_trigger")
}

//
// ALERTS
//

model Alert {
  id String @id @default(cuid())

  triggerId String?       @map("trigger_id")
  trigger   EventTrigger? @relation(fields: [triggerId], references: [id])

  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id])

  compoundId String?   @map("compound_id")
  compound   Compound? @relation(fields: [compoundId], references: [id])

  cellId String? @map("cell_id")
  cell   Cell?   @relation(fields: [cellId], references: [id])

  // alert.sensor_id > sensors.id
  sensorId String? @map("sensor_id")
  sensor   Sensor? @relation(fields: [sensorId], references: [id])

  // alert.commodity_id > commodities.id
  commodityId String?    @map("commodity_id")
  commodity   Commodity? @relation(fields: [commodityId], references: [id])

  // alert.org_id > orgs.id
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // separate user_id on alerts (assigned/owner/etc)
  userId String? @map("user_id")
  user   User?   @relation("alert_user", fields: [userId], references: [id])

  title       String?
  description String

  severity alert_severity
  status   alert_status   @default(OPEN)

  thresholdValue Float?  @map("threshold_value")
  unit           String?

  startedAt  DateTime  @default(now()) @map("started_at")
  resolvedAt DateTime? @map("resolved_at")

  resolvedByUserId String? @map("resolved_by_user_id")
  resolvedByUser   User?   @relation("alert_resolver", fields: [resolvedByUserId], references: [id])

  notifications AlertNotification[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([siteId, status])
  @@index([cellId, status])
  @@index([triggerId, status])
  @@index([sensorId])
  @@index([commodityId])
  @@index([organizationId])
  @@map("alert")
}

//
// NOTIFICATION LOG
//

model AlertNotification {
  id String @id @default(cuid())

  alertId String @map("alert_id")
  alert   Alert  @relation(fields: [alertId], references: [id], onDelete: Cascade)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  channel notification_channel

  recipient String
  status    notification_status @default(PENDING)

  attempts  Int     @default(0)
  lastError String? @map("last_error")

  externalId String? @map("external_id")

  sentAt      DateTime? @map("sent_at")
  deliveredAt DateTime? @map("delivered_at")
  failedAt    DateTime? @map("failed_at")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([alertId])
  @@index([userId])
  @@index([status, attempts])
  @@map("alert_notification")
}

//
// GOODS / COMMODITIES / TRADES
//

model CommodityType {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  status      entity_status

  commodities  Commodity[]
  lookupTables LookupTable[]
  triggers     EventTrigger[]

  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("commodity_type")
}

model LookupTable {
  id          String  @id @default(cuid())
  name        String
  description String?

  commodityTypeId String        @unique @map("commodity_type_id")
  commodityType   CommodityType @relation(fields: [commodityTypeId], references: [id])

  data Json

  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("lookup_table")
}

model Commodity {
  id     String  @id @default(cuid())
  name   String
  origin String?

  commodityTypeId String?        @map("commodity_type_id")
  commodityType   CommodityType? @relation(fields: [commodityTypeId], references: [id])

  // commodities.org_id > orgs.id
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  trades   Trade[]
  alerts   Alert[]
  triggers EventTrigger[]

  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([name])
  @@index([commodityTypeId])
  @@index([organizationId])
  @@map("commodity")
}

model Trade {
  id String @id @default(cuid())

  commodityId String    @map("commodity_id")
  commodity   Commodity @relation(fields: [commodityId], references: [id])

  siteId String @map("site_id")
  site   Site   @relation(fields: [siteId], references: [id])

  compoundId String?   @map("compound_id")
  compound   Compound? @relation(fields: [compoundId], references: [id])

  cellId String? @map("cell_id")
  cell   Cell?   @relation(fields: [cellId], references: [id])

  amountKg  Float    @map("amount_kg")
  tradedAt  DateTime @map("traded_at")
  notes     String?
  direction String?  @default("IN") // IN or OUT
  buyer     String? // Buyer/recipient for OUT trades

  createdBy String? @map("created_by")
  updatedBy String? @map("updated_by")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([siteId, tradedAt])
  @@map("trade")
}
