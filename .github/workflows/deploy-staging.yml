name: Deploy Staging (Azure Container Apps)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  RESOURCE_GROUP: agriq-staging
  CONTAINERAPPS_ENV: agriq-staging-env
  BACKEND_APP: agriq-backend-staging
  FRONTEND_APP: agriq-frontend-staging
  BACKEND_IMAGE: agriq-backend
  FRONTEND_IMAGE: agriq-frontend
  AZURE_SUBSCRIPTION_ID: b97ff88a-e9b9-436d-bb79-c9e4113b9588

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          allow-no-subscriptions: true

      - name: Set Azure Subscription
        run: az account set --subscription "$AZURE_SUBSCRIPTION_ID"

      - name: Get Backend URL (for build)
        id: backend_url_build
        run: |
          BACKEND_FQDN=$(az containerapp show -g "$RESOURCE_GROUP" -n "$BACKEND_APP" --query properties.configuration.ingress.fqdn -o tsv)
          echo "backend_fqdn=$BACKEND_FQDN" >> "$GITHUB_OUTPUT"

      - name: Docker Login (ACR)
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Build Backend
        working-directory: ./backend
        env:
          DATABASE_URL: ${{ secrets.BACKEND_DATABASE_URL }}
        run: |
          npm ci
          npm run build

      - name: Build Frontend
        working-directory: ./frontend
        env:
          NEXT_PUBLIC_API_URL: https://${{ steps.backend_url_build.outputs.backend_fqdn }}
          NEXT_TELEMETRY_DISABLED: 1
        run: |
          npm install --no-audit --no-fund
          npm run build

      - name: Build & Push Backend Image
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE }}:latest
          build-args: |
            DATABASE_URL=${{ secrets.BACKEND_DATABASE_URL }}
            SKIP_BUILD=1

      - name: Build & Push Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ secrets.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:latest
          build-args: |
            SKIP_BUILD=1

      - name: Deploy Backend
        run: |
          if az containerapp show -g "$RESOURCE_GROUP" -n "$BACKEND_APP" > /dev/null 2>&1; then
            az containerapp update \
              -g "$RESOURCE_GROUP" \
              -n "$BACKEND_APP" \
              --image "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE }}:latest" \
              --set-env-vars \
                PORT=3000 \
                DATABASE_URL="${{ secrets.BACKEND_DATABASE_URL }}" \
                JWT_SECRET="${{ secrets.BACKEND_JWT_SECRET }}" \
                WEATHER_API_KEY="${{ secrets.BACKEND_WEATHER_API_KEY }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                GATEWAY_STORAGE_CONTAINER="gateway-updates"
          else
            az containerapp create \
              -g "$RESOURCE_GROUP" \
              -n "$BACKEND_APP" \
              --environment "$CONTAINERAPPS_ENV" \
              --image "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.BACKEND_IMAGE }}:latest" \
              --ingress external \
              --target-port 3000 \
              --registry-server "${{ secrets.ACR_LOGIN_SERVER }}" \
              --registry-username "${{ secrets.ACR_USERNAME }}" \
              --registry-password "${{ secrets.ACR_PASSWORD }}" \
              --env-vars \
                PORT=3000 \
                DATABASE_URL="${{ secrets.BACKEND_DATABASE_URL }}" \
                JWT_SECRET="${{ secrets.BACKEND_JWT_SECRET }}" \
                WEATHER_API_KEY="${{ secrets.BACKEND_WEATHER_API_KEY }}" \
                AZURE_STORAGE_CONNECTION_STRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
                GATEWAY_STORAGE_CONTAINER="gateway-updates"
          fi

      - name: Get Backend URL
        id: backend_url
        run: |
          BACKEND_FQDN=$(az containerapp show -g "$RESOURCE_GROUP" -n "$BACKEND_APP" --query properties.configuration.ingress.fqdn -o tsv)
          echo "backend_fqdn=$BACKEND_FQDN" >> "$GITHUB_OUTPUT"

      - name: Deploy Frontend
        run: |
          if az containerapp show -g "$RESOURCE_GROUP" -n "$FRONTEND_APP" > /dev/null 2>&1; then
            az containerapp update \
              -g "$RESOURCE_GROUP" \
              -n "$FRONTEND_APP" \
              --image "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:latest" \
              --set-env-vars \
                NEXT_PUBLIC_API_URL="https://${{ steps.backend_url.outputs.backend_fqdn }}"
          else
            az containerapp create \
              -g "$RESOURCE_GROUP" \
              -n "$FRONTEND_APP" \
              --environment "$CONTAINERAPPS_ENV" \
              --image "${{ secrets.ACR_LOGIN_SERVER }}/${{ env.FRONTEND_IMAGE }}:latest" \
              --ingress external \
              --target-port 3000 \
              --registry-server "${{ secrets.ACR_LOGIN_SERVER }}" \
              --registry-username "${{ secrets.ACR_USERNAME }}" \
              --registry-password "${{ secrets.ACR_PASSWORD }}" \
              --env-vars \
                NEXT_PUBLIC_API_URL="https://${{ steps.backend_url.outputs.backend_fqdn }}"
          fi

      - name: Get Frontend URL
        id: frontend_url
        run: |
          FRONTEND_FQDN=$(az containerapp show -g "$RESOURCE_GROUP" -n "$FRONTEND_APP" --query properties.configuration.ingress.fqdn -o tsv)
          echo "frontend_fqdn=$FRONTEND_FQDN" >> "$GITHUB_OUTPUT"

      - name: Update Backend FRONTEND_URL
        run: |
          az containerapp update \
            -g "$RESOURCE_GROUP" \
            -n "$BACKEND_APP" \
            --set-env-vars \
              FRONTEND_URL="https://${{ steps.frontend_url.outputs.frontend_fqdn }}"
