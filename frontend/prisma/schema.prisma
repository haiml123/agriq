generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ENUMS
//

enum alert_severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum alert_status {
  OPEN
  ACKNOWLEDGED
  IN_PROGRESS
  RESOLVED
  DISMISSED
}

enum metric_type {
  TEMPERATURE
  HUMIDITY
}

enum trigger_scope {
  ORGANIZATION
  SITE
  COMPOUND
  CELL
}

enum notification_channel {
  EMAIL
  SMS
  PUSH
  WEBHOOK
}

enum notification_status {
  PENDING
  SENT
  DELIVERED
  FAILED
  BOUNCED
}

//
// ORGANIZATION & ACCESS CONTROL
//

model organization {
  id   String @id @default(cuid())
  name String

  users          user[]
  sites          site[]
  roles          user_role[]
  event_triggers event_trigger[]

  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model user {
  id                  String  @id @default(cuid())
  email               String  @unique
  phone               String?
  name                String
  language_preference String?

  organization_id String?
  organization    organization? @relation(fields: [organization_id], references: [id])

  roles user_role[]

  // Triggers
  created_triggers event_trigger[] @relation("trigger_creator")
  updated_triggers event_trigger[] @relation("trigger_updater")

  // Alerts
  resolved_alerts alert[]

  // Notifications received
  notifications alert_notification[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model role {
  id    Int         @id @default(autoincrement())
  name  String      @unique
  users user_role[]
}

model user_role {
  id Int @id @default(autoincrement())

  user_id String
  user    user   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  role_id Int
  role    role @relation(fields: [role_id], references: [id], onDelete: Cascade)

  organization_id String?
  organization    organization? @relation(fields: [organization_id], references: [id])

  site_id String?
  site    site?   @relation(fields: [site_id], references: [id])

  granted_by_user_id String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([user_id, role_id, organization_id, site_id])
}

//
// STRUCTURE: SITE → COMPOUND → CELL
//

model site {
  id   String @id @default(cuid())
  name String

  organization_id String
  organization    organization @relation(fields: [organization_id], references: [id])

  compounds compound[]
  alerts    alert[]
  trades    trade[]
  roles     user_role[]
  triggers  event_trigger[]

  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model compound {
  id   String @id @default(cuid())
  name String

  site_id String
  site    site   @relation(fields: [site_id], references: [id])

  cells    cell[]
  alerts   alert[]
  trades   trade[]
  triggers event_trigger[]

  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model cell {
  id   String @id @default(cuid())
  name String

  compound_id String
  compound    compound @relation(fields: [compound_id], references: [id])

  sensors  sensor[]
  alerts   alert[]
  readings sensor_reading[]
  trades   trade[]
  triggers event_trigger[]

  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

//
// SENSORS
//

model sensor {
  id          String  @id @default(cuid())
  external_id String  @unique
  name        String?
  is_active   Boolean @default(true)

  cell_id String
  cell    cell   @relation(fields: [cell_id], references: [id])

  readings sensor_reading[]

  created_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model sensor_reading {
  id        String @id @default(cuid())
  sensor_id String
  sensor    sensor @relation(fields: [sensor_id], references: [id])

  cell_id String
  cell    cell   @relation(fields: [cell_id], references: [id])

  metric      metric_type
  value       Float
  recorded_at DateTime
  created_at  DateTime    @default(now())

  @@index([sensor_id, metric, recorded_at])
  @@index([cell_id, metric, recorded_at])
}

//
// EVENT TRIGGERS - with JSON conditions and actions
//

model event_trigger {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Scope - where does this trigger apply?
  scope_type      trigger_scope
  organization_id String?
  organization    organization? @relation(fields: [organization_id], references: [id])
  site_id         String?
  site            site?         @relation(fields: [site_id], references: [id])
  compound_id     String?
  compound        compound?     @relation(fields: [compound_id], references: [id])
  cell_id         String?
  cell            cell?         @relation(fields: [cell_id], references: [id])

  // ============================================
  // CONDITIONS - stored as JSON
  // ============================================
  // {
  //   "logic": "AND" | "OR",
  //   "items": [
  //     {
  //       "metric": "TEMPERATURE" | "HUMIDITY",
  //       "type": "THRESHOLD",
  //       "operator": "ABOVE" | "BELOW" | "EQUALS" | "BETWEEN",
  //       "value": 30,
  //       "secondaryValue": 40  // only for BETWEEN
  //     },
  //     {
  //       "metric": "TEMPERATURE",
  //       "type": "CHANGE",
  //       "direction": "INCREASE" | "DECREASE" | "ANY",
  //       "amount": 5,
  //       "timeWindowDays": 7
  //     }
  //   ]
  // }
  conditions Json

  // ============================================
  // ACTIONS - stored as JSON
  // ============================================
  // [
  //   { "type": "EMAIL", "recipients": ["user-id-1"] },
  //   { "type": "SMS", "recipients": ["user-id-1"] },
  //   { "type": "PUSH" },
  //   { "type": "WEBHOOK", "url": "https://..." }
  // ]
  actions Json

  // Severity when triggered
  severity alert_severity @default(MEDIUM)

  // Is this trigger active?
  is_active Boolean @default(true)

  // Alerts generated by this trigger
  alerts alert[]

  // Audit
  created_by      String
  created_by_user user    @relation("trigger_creator", fields: [created_by], references: [id])
  updated_by      String?
  updated_by_user user?   @relation("trigger_updater", fields: [updated_by], references: [id])

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([is_active, scope_type])
  @@index([site_id])
  @@index([organization_id])
}

//
// ALERTS
//

model alert {
  id String @id @default(cuid())

  trigger_id String?
  trigger    event_trigger? @relation(fields: [trigger_id], references: [id])

  site_id String
  site    site   @relation(fields: [site_id], references: [id])

  compound_id String?
  compound    compound? @relation(fields: [compound_id], references: [id])

  cell_id String?
  cell    cell?   @relation(fields: [cell_id], references: [id])

  title        String?
  description  String
  trigger_type metric_type
  severity     alert_severity
  status       alert_status   @default(OPEN)

  threshold_value Float?
  unit            String?

  started_at  DateTime  @default(now())
  resolved_at DateTime?

  resolved_by_user_id String?
  resolved_by_user    user?   @relation(fields: [resolved_by_user_id], references: [id])

  // Notifications sent for this alert
  notifications alert_notification[]

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([site_id, status])
  @@index([cell_id, status])
  @@index([trigger_id, status])
}

//
// NOTIFICATION LOG - tracks every notification sent
//

model alert_notification {
  id String @id @default(cuid())

  alert_id String
  alert    alert  @relation(fields: [alert_id], references: [id], onDelete: Cascade)

  // Who was notified (null for webhooks)
  user_id String?
  user    user?   @relation(fields: [user_id], references: [id])

  // How they were notified
  channel notification_channel

  // Delivery details
  recipient String // email address, phone number, webhook URL
  status    notification_status @default(PENDING)

  // For retries
  attempts   Int     @default(0)
  last_error String?

  // External provider reference (SendGrid message ID, Twilio SID, etc.)
  external_id String?

  // Timestamps
  sent_at      DateTime?
  delivered_at DateTime?
  failed_at    DateTime?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([alert_id])
  @@index([user_id])
  @@index([status, attempts])
}

//
// GOODS / COMMODITIES / TRADES
//

model commodity_type {
  id          String  @id @default(cuid())
  name        String  @unique
  description String?
  is_active   Boolean @default(true)

  commodities   commodity[]
  lookup_tables lookup_table[]

  created_by String?
  updated_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model lookup_table {
  id          String  @id @default(cuid())
  name        String
  description String?

  commodity_type_id String         @unique
  commodity_type    commodity_type @relation(fields: [commodity_type_id], references: [id])

  // { tempRanges: [], humidityRanges: [], values: [][] }
  data Json

  created_by String?
  updated_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
}

model commodity {
  id     String  @id @default(cuid())
  name   String
  origin String?

  commodity_type_id String?
  commodity_type    commodity_type? @relation(fields: [commodity_type_id], references: [id])

  trades trade[]

  created_by String?
  updated_by String?
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([name])
  @@index([commodity_type_id])
}

model trade {
  id String @id @default(cuid())

  commodity_id String
  commodity    commodity @relation(fields: [commodity_id], references: [id])

  site_id String
  site    site   @relation(fields: [site_id], references: [id])

  compound_id String?
  compound    compound? @relation(fields: [compound_id], references: [id])

  cell_id String?
  cell    cell?   @relation(fields: [cell_id], references: [id])

  amount_kg Float
  traded_at DateTime
  notes     String?

  created_by String?
  updated_by String?

  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([site_id, traded_at])
}
